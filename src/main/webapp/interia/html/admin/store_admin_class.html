<!DOCTYPE html>
<html>

<head>
<title>공방관리자</title>
<meta charset="utf-8">
<link rel="stylesheet"
	href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css"
	href="../../css/admin/store_admin_common.css">
<link rel="stylesheet"
	href="../../node_modules/@fortawesome/fontawesome-free/css/all.css">
<link rel="stylesheet"
	href="../../node_modules/blueimp-file-upload/css/jquery.fileupload.css">
<link rel="stylesheet"
	href="../../node_modules/blueimp-file-upload/css/jquery.fileupload-ui.css">
<link rel="shortcut icon" href="../favicon.ico">


</head>

<body>
	<div id="ad-header"></div>
	<div id="adModalbox"></div>
	<div class="ad-main-wrapper">
		<div class="ad-main-content">
			<!-- ad-breadcrumb -->
			<ol class="ad-breadcrumb">
				<li class="ad-breadcrumb-item"><a href="#">관리자</a></li>
				<li class="ad-breadcrumb-item active">체험관리</li>
			</ol>
			<div class="ad-card-default">
				<div class="ad-card-header">
					<i class="fas fa-chalkboard-teacher"></i> 체험목록
				</div>
				<div class="ad-card-body">
					<div id="ad-class-addForm" class="ad-class-enroll" data-toggle="modal"
						data-target="#classModal">
						<i class="far fa-plus-square"></i> 체험 등록하기
					</div>
					<div class="ad-class-data">

					</div>
				</div>
			</div>
			
<!-- classAddModal -->
<div class="modal fade" id="classModal" tabindex="-1"
	role="dialog" aria-labelledby="classModalTitle"
	aria-hidden="true" style="z-index: 10800;">
	<div class="modal-dialog modal-lg " role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="classModalTitle">
					<b>체험등록</b>
				</h5>
				<button type="button" class="close" data-dismiss="modal"
					aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form method="post">
				<div class="modal-body">
				<input type="text" id="wsano" style="display: none;">
					<div class="ad-modal-contentgap">
						<b>체험명</b> <input type="text" id="acnm"
							class="ad-works-modal-inputlg ad-works-modal-content"
							placeholder="체험명을 입력해주세요">
					</div>
					<div class="ad-modal-contentgap">
						<b>모집인원</b> <input type="number" id="minno"
							class="ad-class-num ad-works-modal-content" min="1" max="20"
							placeholder="최소인원"> <input type="number" id="maxno"
							class="ad-class-num ad-works-modal-content" min="1" max="20"
							placeholder="최대인원">
					</div>
					<div class="ad-modal-content-collapse">
						<div class="ad-modal-contentgap">
							<b>체험일자</b> <input type="date" id="actdt"
								class="ad-works-modal-content">
						</div>
						<div class="ad-modal-contentgap">
							<b>체험시간</b> <input type="time" id="avst" class="">
							&ensp; ~ &ensp; <input type="time" id="avet" class="">
						</div>
					</div>
					<div class="ad-modal-content-collapse">
						<div class="ad-modal-contentgap">
							<b>준비물</b><input
								type="text" id="mtrls"
								class="ad-works-modal-inputsm ad-works-modal-content"
								placeholder="준비물을 입력하세요">
						</div>
						<div class="ad-modal-contentgap">
							<b>체험료</b> <input type="text" id="apric"
								class="ad-works-modal-inputsm ad-works-modal-content"
								placeholder="가격">
						</div>
					</div>
					<div class="ad-modal-contentgap" id="ad-class-fileUpload">
						<b>사진첨부</b> <input id="fileupload" type="file" name="files"
							multiple>
						<div id="ad-images-div">
						</div>
						<button class="ad-btn ad-btn-color3" id='imgUpload'
							type='button'>파일첨부</button>
						<!-- <button class="ad-btn ad-btn-color1" id='upload-btn' type='button'>등록</button> -->
					</div>
					<div class="ad-modal-contentgap">
						<b>체험상세</b> <br />
						<textarea class="form-control form-rounded ad-class-discrpt" name="content" id="accnt" cols='87'></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button type="reset" class="ad-btn ad-btn-color3">초기화</button>
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">닫기</button>
					<button type="button" id='addBtn' class="ad-btn ad-btn-color1">등록하기</button>
<!--<button type="button" id='updBtn' class="ad-btn ad-btn-color1">수정하기</button> -->
				</div>
			</form>
		</div>
	</div>
</div>


			<!--requestUserModal-->
			<div class="modal fade" id="requestUserModal" tabindex="-1"
				role="dialog" aria-labelledby="requestUserModalTitle"
				aria-hidden="true" style="z-index: 10800;">
				<div class="modal-dialog modal-dialog-centered " role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="requestUserModalTitle">
								<b>신청현황</b>
							</h5>
							<button type="button" class="close" data-dismiss="modal"
								aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<form>
							<div class="modal-body">
								<div class="ad-modal-contentgap">
									<b>체험명</b>
									<div class="ad-apList-wrapper">
										<div class="ad-apList-header">
											<div class="ad-apList-left">신청자 닉네임</div>
											<div class="ad-apList-right">신청 인원</div>
										</div>
										<div class="ad-apList-row">
											<div class="ad-apList-left">소확행이좋아</div>
											<div class="ad-apList-right">4 명</div>
										</div>
										<div class="ad-apList-row">
											<div class="ad-apList-left">이쁜집에살자</div>
											<div class="ad-apList-right">2 명</div>
										</div>
										<div class="ad-apList-row">
											<div class="ad-apList-left">인테리어가좋아</div>
											<div class="ad-apList-right">2 명</div>
										</div>
									</div>
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary"
									data-dismiss="modal">닫기</button>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
		<!-- ad-main-content-->
	</div>
	
<script id ="ad-class-wrapper-template" type="text/x-handlebars-template">
{{#each list}}
<div class="ad-class-wrapper">
  <div class="ad-class-card">
    <div class="ad-class-card-img"><img src="../../../files/workshop/activity/{{path}}_200x200.jpg"></div>
    <div class="ad-class-card-content"><p class="ad-class-card-title">{{acnm}}</p><p>{{accnt}}</p></div>
    <div class="ad-class-card-info"><p>최대인원 {{maxno}}명</p><p>가격 {{apric}} 원</p><p>체험일자</p><p>{{year}}-{{month}}-{{day}}</p><p>({{hour}}시간{{minute}}분)</p></div>
    <div class="ad-class-opt ad-btn-group-collapse">
      <button class="ad-btn-sm ad-btn-color1" data-toggle="modal" data-target="#requestUserModal">신청현황</button>
      <button class="ad-btn-sm ad-btn-color3 ad-class-card-update" data-wsano="{{wsano}}" data-toggle="modal" data-target="#classModal">수정</button>
      <button class="ad-btn-sm ad-btn-color2" onclick="classdel({{wsano}})">삭제</button></div>
  </div>
</div>

{{/each}}

</script>
<!-- 	<button class="ad-btn-sm ad-btn-color2" onclick="classdel({{wsano}})">삭제</button></div> -->
	<!--ad-main-wrapper-->
	<script src="../../node_modules/handlebars/dist/handlebars.min.js"></script>
	<script src="../../node_modules/jquery/dist/jquery.min.js"></script>
	<script
		src="../../node_modules/blueimp-file-upload/js/vendor/jquery.ui.widget.js"></script>
	<script
		src="../../node_modules/blueimp-load-image/js/load-image.all.min.js"></script>
	<script
		src="../../node_modules/blueimp-canvas-to-blob/js/canvas-to-blob.js"></script>
	<script src="../../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
	<script
		src="../../node_modules/blueimp-file-upload/js/jquery.iframe-transport.js"></script>
	<script
		src="../../node_modules/blueimp-file-upload/js/jquery.fileupload.js"></script>
	<script
		src="../../node_modules/blueimp-file-upload/js/jquery.fileupload-process.js"></script>
	<script
		src="../../node_modules/blueimp-file-upload/js/jquery.fileupload-image.js"></script>
	<script src="../../node_modules/popper.js/dist/umd/popper.min.js"></script>
<!-- 	<script
		src="../../node_modules/@ckeditor/ckeditor5-build-classic/build/ckeditor.js"></script>
	<script
		src="../../node_modules/@ckeditor/ckeditor5-build-classic/build/translations/ko.js"></script> -->
	<script src="../../js/common.js"></script>
	<script src="../../js/ad_header.js"></script>
	<script src="../../js/ad_admin.js"></script>
	<!-- <script src="../../js/ad_editor.js"></script>
	<script src="../../js/upload.js"></script> -->

<script>
"use strict"
var userNo;
var adClassData = $('.ad-class-data');
var adClassEnrollBtn = $('.ad-class-enroll');
var adClassWrapperTemplateSrc = $('#ad-class-wrapper-template').html();
var adClassWrapperTemplate = Handlebars.compile(adClassWrapperTemplateSrc);

/*button 클릭시 파일 첨부 */	
$(function () {
	$('#imgUpload').click(function (e) {
		e.preventDefault();
		$('#fileupload').click();
	});
});

$.getJSON(serverRoot + "/json/auth/loginUser", (data) => {
	//공방번호(사용자번호(PK))
	userNo = data.no;
	
	/* list */
	$.getJSON(serverRoot + "/json/wsav/adminList",{"no":userNo}, (data) => {
		console.log(userNo);
		console.log(data);
		for (var item of data) {
			var date = new Date(item.actdt);
			var year = date.getFullYear();
			var month =(1+date.getMonth());
			month = month >= 10 ? month:'0' + month;
			var day = date.getDate();
			day = day >= 10 ? day:'0' + day;
			
			item.year = year;
			item.month = month;
			item.day = day;
			
			var str = item.time.split(":");
			item.hour = str[0];
			item.minute = str[1];
		}
		$(adClassWrapperTemplate({list: data})).appendTo(adClassData);
	});
});

/* view */
adClassData.on('click', '.ad-class-card-update', function(e) {
	var no = $(e.target).attr('data-wsano');
	$.getJSON(serverRoot + "/json/wsav/" + no, (data) => {
		console.log(data);
		$(acnm).val(data.title);
        $(minno).val(data.minPerson);
        $(maxno).val(data.maxPerson);
        $(actdt).val(data.experDate);
        $(avst).val(data.startTime);
        $(avet).val(data.endTime);
        $(mtrls).val(data.prepareCont);
        $(apric).val(data.price);
        $(accnt).val(data.content);
        $(wsano).val(data.no);
	});
	
	adClassEnrollBtn.trigger('click', ['update']);
});

/*
$('#classAddModal').on('shown.bs.modal', function () {
  alert('okok')
}); */

$('#ad-class-addForm').click(function(e, action) {
	if (action === 'update') {
		console.log(action);
		$('#fileupload').fileupload('option', 'url', '../../../json/wsav/update');
		$('.modal-title').text("체험수정");
		$('#addBtn').attr("id","updBtn");
		$('#updBtn').text("수정하기");
	} else {
		$('#fileupload').fileupload('option', 'url', '../../../json/wsav/add');
		$('.modal-title').text("체험등록");
		$('#updBtn').attr("id","addBtn");
		$('#addBtn').text("등록하기");
		
	}
})

/*// fileUpload : add & update*/
var imgFiles;
$('#fileupload').fileupload({
	dataType: 'json',
	sequentialUploads: true,
	singleFileUploads: false,
	autoUpload: false,
	disableImageResize: /Android(?!.*Chrome)|Opera/
		.test(window.navigator && navigator.userAgent), // 안드로이드와 오페라 브라우저는 크기 조정 비활성 시키기
	previewMaxWidth: 80,   // 미리보기 이미지 너비
	previewMaxHeight: 80,  // 미리보기 이미지 높이 
	previewCrop: true,      // 미리보기 이미지를 출력할 때 원본에서 지정된 크기로 자르기
	processalways: function (e, data) {
		console.log('fileuploadprocessalways()...');
		imgFiles = data.files;
		var imagesDiv = $('#ad-images-div');
		imagesDiv.html("");
		for (var i = 0; i < data.files.length; i++) {
			try {
				if (data.files[i].preview.toDataURL) {
					var imgWrapper = $('<div>')
						.attr("data-file-index", i)
						.addClass('ad-adImgs-wrapper')
						.click(delImg)
						.appendTo(imagesDiv);
					var imgContent = $('<div>')
						.addClass('ad-adImgs-content')
						.appendTo(imgWrapper);
					var imgCover = $('<div>')
						.addClass('ad-adImgs-cover')
						.appendTo(imgWrapper);
					$("<img/>").attr('src', data.files[i].preview.toDataURL()).appendTo(imgContent).addClass('ad-adImgs');
				}
			} catch (err) { }
		}
		
		$('#addBtn').off('click');
		
		$('#updBtn').off('click');
		
		$('#updBtn').click(function () {
			data.formData = {
				workshopNo: userNo,
				title: $(acnm).val(),
				minPerson: $(minno).val(),
				maxPerson: $(maxno).val(),
				experDate: $(actdt).val(),
				startTime: $(avst).val(),
				endTime: $(avet).val() ,
				prepareCont: $(mtrls).val(),
				price: $(apric).val(),
				content: $(accnt).val(),
				no:$(wsano).val()
			};
			console.log(data);
			
			data.submit();
		});
		
		$('#addBtn').click(function () {
			data.formData = {
				workshopNo: userNo,
				title: $(acnm).val(),
				minPerson: $(minno).val(),
				maxPerson: $(maxno).val(),
				experDate: $(actdt).val(),
				startTime: $(avst).val() + ":00",
				endTime: $(avet).val() + ":00",
				prepareCont: $(mtrls).val(),
				price: $(apric).val(),
				content: $(accnt).val()
			};    
			console.log(data);
			data.submit();
		});
		
	},
	
	done: function (e, data) { // 서버에서 응답이 오면 호출된다. 각 파일 별로 호출된다.
		console.log('done()...');
		console.log(data.result);
	}
});

/*delete*/
 function classdel(no) {
     if (window.confirm("삭제하시겠습니까?") == false) 
     	return;
     $.get("../../../json/wsav/adminDelete", {"wsano": no}, () => {
    	 
     });
/*      location.reload(); */  
}

/*미리보기 삭제 이벤트*/
function delImg(event) {
	var wrapperDiv = $(event.currentTarget);
	wrapperDiv.remove();
	var fileIndex = wrapperDiv.attr('data-file-index');
	imgFiles.splice(fileIndex, 1);
}


		

</script>
</body>

</html>